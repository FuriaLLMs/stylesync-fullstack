{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 card p-4 shadow">
        <h3 class="text-center mb-4">ðŸ“‚ Importar Vendas (CSV)</h3>

        <div class="alert alert-info">
            <small>O arquivo CSV deve conter as colunas: <strong>date, product_id, quantity, amount</strong>.</small>
        </div>

        <form id="uploadForm">
            <div class="mb-3">
                <label for="csvFile" class="form-label">Selecione o arquivo CSV</label>
                <input class="form-control" type="file" id="csvFile" accept=".csv" required>
            </div>
            <button type="submit" class="btn btn-success w-100">
                <span id="btnText">Enviar Arquivo</span>
                <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status"
                    aria-hidden="true"></span>
            </button>
        </form>

        <div id="resultArea" class="mt-3 d-none">
            <div id="alertBox" class="alert" role="alert"></div>
            <ul id="errorList" class="list-group"></ul>
        </div>
    </div>
</div>

<script>
    document.getElementById('uploadForm').onsubmit = async (e) => {
        e.preventDefault();

        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login_page';
            return;
        }

        const fileInput = document.getElementById('csvFile');
        const file = fileInput.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        // UI Feedback
        const btnFn = document.querySelector('button[type="submit"]');
        const btnText = document.getElementById('btnText');
        const spinner = document.getElementById('spinner');
        const resultArea = document.getElementById('resultArea');
        const alertBox = document.getElementById('alertBox');
        const errorList = document.getElementById('errorList');

        btnFn.disabled = true;
        btnText.textContent = "Enviando...";
        spinner.classList.remove('d-none');
        resultArea.classList.add('d-none');
        errorList.innerHTML = '';

        try {
            const res = await fetch('/sales/upload', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                    // NÃ£o defina Content-Type aqui, o browser define automaticamente para multipart/form-data com boundary
                },
                body: formData
            });

            const data = await res.json();

            resultArea.classList.remove('d-none');

            if (res.ok) {
                alertBox.className = 'alert alert-success';
                alertBox.textContent = `${data.message} (${data.vendas_importadas} vendas importadas)`;

                if (data.erros_encontrados && data.erros_encontrados.length > 0) {
                    alertBox.classList.add('alert-warning');
                    alertBox.innerHTML += '<br><strong>AtenÃ§Ã£o:</strong> Alguns erros ocorreram:';
                    data.erros_encontrados.forEach(err => {
                        errorList.innerHTML += `<li class="list-group-item list-group-item-danger small">${err}</li>`;
                    });
                } else {
                    // Limpa o form se tudo deu certo
                    fileInput.value = '';
                }

            } else {
                alertBox.className = 'alert alert-danger';
                alertBox.textContent = 'Erro: ' + (data.error || 'Falha desconhecida');
            }

        } catch (error) {
            console.error(error);
            resultArea.classList.remove('d-none');
            alertBox.className = 'alert alert-danger';
            alertBox.textContent = 'Erro de conexÃ£o ou script.';
        } finally {
            btnFn.disabled = false;
            btnText.textContent = "Enviar Arquivo";
            spinner.classList.add('d-none');
        }
    };
</script>
{% endblock %}